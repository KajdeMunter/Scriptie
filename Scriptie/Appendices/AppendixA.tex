% Appendix A

\chapter{Code} % Main appendix title

\label{BijlageCode} 

\section{Docker-compose opstelling voor k6, InfluxDB \& Grafana}

\label{Bijlagek6}

Om de loadtest met k6, influxDB en grafana op te stellen heeft Loadimpact een docker-compose opstelling gemaakt. Na wat onderzoek is het opgevallen dat deze opstelling erg verouderd is. Daarom is ervoor gekozen om een eigen opstelling te maken:
\begin{minted}[linenos=true, bgcolor=codebg, breaklines]{yaml}
version: '3.4'

networks:
  k6:
  grafana:

services:
  influxdb:
    image: influxdb:1.5.4
    networks:
    - k6
    - grafana
    ports:
      - "8086:8086"
    environment:
      - INFLUXDB_DB=k6
    
  grafana:
    image: grafana/grafana:6.4.1
    networks:
      - grafana
    ports:
      - "3000:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_BASIC_ENABLED=false
    volumes:
      - ./grafana/datasource.yml:/etc/grafana/provisioning/datasources/datasource.yml
  
  k6:
    image: loadimpact/k6:0.25.1
    networks:
      - k6
    ports:
      - "6565:6565"
    environment:
      - K6_OUT=influxdb=http://influxdb:8086/k6
    volumes:
      - ../k6:/k6
\end{minted}

Hiervoor is een Pull-request gedaan naar loadimpact/k6 om dit te verbeteren. \texttt{https://github.com/loadimpact/k6/pull/1183} samen met de issue\\ \texttt{https://github.com/loadimpact/k6/issues/1182}. Hierin is te lezen wat precies de veranderingen waren. De loadtest is geschreven in javascript met de volgende code:
\begin{minted}[linenos=true, bgcolor=codebg, breaklines]{javascript}
import http from "k6/http";
import { sleep, check } from "k6";

export let options = {
  stages: [
    { duration: "10s", target: 20 },
    { duration: "10s", target: 40 },
    { duration: "10s", target: 60 },
  ]
};

export default function() {
  check(http.get("https://test.developers.nl/"), {
    "is status 200": (r) => r.status === 200
  });
  sleep(1);
};
\end{minted}

\section{Docker container exits}

\label{DockerExits}

\subsubsection{PostgreSQL}
\begin{minted}[linenos=true, bgcolor=codebg, breaklines]{text}
LOG: received smart shutdown request
LOG: background worker "logical replication launcher" (PID 43) exited with exit code 1
LOG: shutting down
LOG: database system is shut down
\end{minted}

\subsubsection{PHP-FPM}
\begin{minted}[linenos=true, bgcolor=codebg, breaklines]{text}
NOTICE: Terminating ...
NOTICE: exiting, bye-bye!
\end{minted}

\subsubsection{Redis}
\begin{minted}[linenos=true, bgcolor=codebg, breaklines]{text}
1:signal-handler (1570781278) Received SIGTERM scheduling shutdown...
# User requested shutdown...
* Saving the final RDB snapshot before exiting.
* DB saved on disk
* Removing the pid file.
# Redis is now ready to exit, bye bye...
\end{minted}

\subsubsection{Nginx}
\begin{minted}[linenos=true, bgcolor=codebg, breaklines]{text}
[notice] 1#1: signal 15 (SIGTERM) received from 56, exiting
[notice] 48#48: exiting
[notice] 47#47: exiting
[notice] 47#47: exit
[notice] 1#1: signal 14 (SIGALRM) received
[notice] 1#1: signal 17 (SIGCHLD) received from 48
[notice] 1#1: cache manager process 48 exited with code 0
[notice] 1#1: worker process 47 exited with code 0
[notice] 1#1: exit
\end{minted}

\section{Docker container kill \& restarts}

\label{DockerKills}

\begin{minted}[linenos=true, bgcolor=codebg, breaklines]{text}
$ docker ps -q
d0829783af18
f72e9967771b
01dd48ff5a59
fab794731d47
ca510c065d11
3ee85578efb5

$ docker kill $(docker ps -q) 

$ docker ps
d0829783af18
f72e9967771b
01dd48ff5a59
fab794731d47
ca510c065d11
3ee85578efb5

$ docker ps -q

$ docker start $(docker ps -aq)
d0829783af18
f72e9967771b
01dd48ff5a59
fab794731d47
d68d7ab9809c
ca510c065d11
3ee85578efb5
e1866ab6c1af

$ docker ps -q
d0829783af18
f72e9967771b
01dd48ff5a59
fab794731d47
ca510c065d11
3ee85578efb5
\end{minted}