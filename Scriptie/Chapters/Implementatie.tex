\chapter{Implementatie}

\label{Chapter6}

Dit hoofdstuk gaat over de deelvraag \enquote{\deelimplementatie}. In dit hoofdstuk staat de bijbehorende gedachtegang met referenties naar de code en ontwerpen in bijlage \ref{BijlageCode}.

\section{Feature-environments}

Alle code en ontwerpen zijn te vinden in bijlage \ref{CodeFeatureEnvironments}. Om te helpen met de ontwikkelfase en documentatie zijn allereerst twee diagrammen ontworpen. Een component diagram voor de Docker containers samen met de reverse proxy (figuur \ref{traefikinfrastructure}). Dit is een bijgewerkte versie van figuur \ref{fig:infra}. Daarnaast is een activity diagram ontworpen om de deployment workflow te visualiseren (figuur \ref{activitydiagram}).

\begin{figure}[H]
	\centering
	\includegraphics[width=9cm]{Figures/Traefik}
	\decoRule
	\caption[Traefik Infrastructure]{Nieuwe infrastructuur met Traefik reverse proxy}
	\label{traefikinfrastructure}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=13cm]{Figures/Activitydiagram}
	\decoRule
	\caption[Pipeline Activity Diagram]{Activity Diagram voor de pipeline}
	\label{activitydiagram}
\end{figure}

Hierna is de Docker opstelling gemaakt voor Traefik. De bestaande drie docker-compose bestanden zijn aangepast door de Nginx service labels te geven die zorgen voor de service-discovery van Traefik. Vervolgens zijn basis, productie, en development docker-compose bestanden aangemaakt voor Traefik. Het afhandelen van SSL in development gebeurt niet meer via Nginx maar via Traefik, daarom is de development\_ssl service hier naar verplaatst. Deze service is tevens ook aangepast om wildcard certificaten te genereren, en niet meer afhankelijk te zijn van een image uit een derde partij. Hierdoor is ook de Nginx configuratie aangepast om de afhandeling van SSL niet meer te ondersteunen. Ook is een configuratiebestand voor traefik toegevoegd voor de TLS instellingen. Om de development omgeving te ondersteunen is de Makefile bijgewerkt en een script gemaakt om de omgeving op te zetten. Dit script gebruikt de development Docker-compose bestanden om de containers te draaien en verbind vervolgens Nginx met Traefik.

Traefik runt standaard als root, dit is geen best-practice voor het gebruiken van Docker Containers \parencite{DockerBestPractices}. Daarom is een Dockerfile toegevoegd die verder bouwt op de Traefik image. Deze dockerfile maakt een user en group aan om deze vervolgens te gebruiken om het proces mee te runnen. Deze user en group komen overeen met users op de host machine, waardoor deze rechten heeft tot de Docker client certificaten.

Vervolgens is er een Ansible role ontwikkeld om de Docker Daemon te beveiligen via TLS\footnote{https://github.com/ansible/role-secure-docker-daemon is gebruikt voor inspiratie, maar omdat dit project erg verouderd is, is besloten om een verbeterde versie te ontwikkelen.}. Om te helpen bij de ontwikkeling is eerst een Vagrantfile toegevoegd om met Virtualbox lokaal de Ansible role te kunnen testen. Deze role genereert een Certificate Authority (CA), server, en client keys door middel van OpenSSL. Ook zorgt deze role er voor dat de Docker Daemon correct is ingesteld om deze certificaten te kunnen gebruiken, en dat de permissions van alle bestanden juist zijn ingesteld. Er wordt gebruik gemaakt van Ansible-Vault om de passphrase van de certificaten veilig op te slaan.

Om de implementatie te deployen naar productie zijn de bestaande Ansible roles aangepast om gebruik te maken van de Traefik proxy en beveiligde Docker Daemon. In de frontend-images role is de dockerfile toegevoegd met de relevante build arguments. De frontend role haalt de environment variabelen uit de Bitbucket Pipeline en parsed deze om zo de correcte subdomein, Fully Qualified Domain Name (FQDN), en network name te registreren. Deze worden gebruikt als variabelen in de docker-compose bestanden om zo de correcte subdomeinen aan te maken. Vervolgens worden de containers gebuild en Nginx aan de Traefik en PHP-FPM containers verbonden. Zodra de naam van de git branch geen \enquote{Feature/WEB-} bevat wordt er geen aparte feature-environment gebruikt voor de deployment.

De Bitbucket Pipeline is aangepast om Traefik te updaten bij een deployment of bootstrap.

\section{Codecov}
Code voor het implementeren is te zien in bijlage \ref{codecov}. De README is bijgewerkt, Bitbucket en codecoverage environment variabelen moesten worden doorgegeven door build arguments. Het builden van de Docker images gebeurt met Ansible. In de php7-fpm dockerfile zijn de build args omgezet naar environment variablen, een aantal apk packages toegevoegd en is het codecov script toegevoegd. Er is een script geschreven om pcov te installeren zodat dit kan hergebruikt worden zowel in de `develop.sh` entrypoint als in de test-stage van de dockerfile.

Om BitBucket een betere ondersteuning te geven met codecov is hier ook een Pull-Request naar codecov-bash gemaakt. Deze is te zien op:\\ \texttt{https://github.com/codecov/codecov-bash/pull/225}. De maintainers van codecov waren tevreden met deze verbeteringen en hebben de Pull-Request geaccepteerd en gemerged.

\section{Opschonen Docker images}
In het bestand \texttt{developers.nl/ansible/group\_vars/all.yml} is een variabele geplaatst om de images te filteren, images die ouder zijn dan 4 uur worden verwijderd.
\begin{minted}[linenos=true, bgcolor=codebg]{yaml}
image_delete_until_time: 4h
\end{minted}
\\In \texttt{developers.nl/ansible/deploy.yml} is een ansible taak geplaatst die gebruik maakt van de \texttt{docker\_prune} module, om zo alle dangling images te verwijderen.
\begin{minted}[linenos=true, bgcolor=codebg]{yaml}
- name: "Clean up images older than {{ image_delete_until_time }}"
  docker_prune:
    images: yes
    images_filters:
      dangling: false
      until: "{{ image_delete_until_time }}"
  register: prune_result
\end{minted}

\section{Policy as Code}

\textcolor{red}{TODO: PoC} % TODO: POLICIES AS CODE

\section{Logging \& Monitoring}
Bij de implementatie van Prometheus blijkt dat er twee dingen moeten gebeuren voordat Prometheus correct kan werken in productie. 
\begin{enumerate}
    \item De Docker Daemon moet in \enquote{experimental} mode draaien
    \item Docker moet in Swarm mode draaien
\end{enumerate}
Docker raad het volgende aan \parencite{DockerExperimental}: \enquote{Experimental features must not be used in production environments}. Verder draait de website (nog) niet in Swarm mode. Door deze is het verstandig om te wachten met de implementatie van Prometheus. Wel is Grafana ge√Ømplementeerd door gebruik te maken van de Grafana Docker image en labels toe te voegen waardoor Traefik weet waar de request heen moet. Traefik maakt een subdomein aan op \texttt{grafana.<root\_server\_name>}. De implementatie staat in bijlage \ref{GrafanaImplementatie}.

\section{Conclusie}
